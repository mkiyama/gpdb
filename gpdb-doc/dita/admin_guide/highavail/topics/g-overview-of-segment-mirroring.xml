<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE topic
  PUBLIC "-//OASIS//DTD DITA Composite//EN" "ditabase.dtd">
<topic id="topic3">
    <title>Overview of Segment Mirroring</title>
    <body>
        <p>When Greenplum Database High Availability is enabled, there are two types of segments:
                <i>primary</i> and <i>mirror</i>. Each primary segment has one corresponding mirror
            segment. A primary segment receives requests from the master to make changes to the
            segment's database and then replicates those changes to the corresponding mirror. If a
            primary segment becomes unavailable, database queries fail over to the mirror
            segment.</p>
        <draft-comment author="msk">Need to update description using WAL master
            mirroring</draft-comment>
        <p>When a segment mirroring is configured for a system, the primary segments continue
            provide service to users while a transactional snapshot of the primary segment instances
            are taken. While the transactional snapshots are taken and deployed on the mirror
            segment instances, changes to the primary master are also recorded. After the snapshot
            is deployed on the mirror segments, the updates are deployed to synchronize the mirror
            segments with the primary segments.</p>
        <p>Once the primary segments and mirror segments are synchronized, the mirror segments are
            kept up to date by the <codeph>walsender</codeph> and <codeph>walreceiver</codeph>
            replication processes. The <codeph>walreceiver</codeph> is a mirror segment process. The
                <codeph>walsender</codeph> process is a primary segment process. The two processes
            use Write-Ahead Logging (WAL)-based streaming replication to keep the primary segments
            and mirror segments synchronized. In WAL logging, all modifications are written to the
            log before being applied, to ensure data integrity for any in-process operations.</p>
        <p>When Greenplum Database detects a primary segment failure, the WAL replication process
            stops and the mirror segment automatically starts as the active primary segment
            instance. </p>
        <p>If a mirror segment fails or becomes inaccessible while the primary is active, the
            primary's system state changes <codeph>n</codeph> (not sycnching), and it tracks changes
            to be applied to the mirror when it is recovered.</p>
        <p>WAL logging is used for both master and segment mirroring.</p>
        <p>The catalog table <codeph>gp_segment_configuration</codeph> reflects state of primary and
            mirror segments as well as the master and standby master instance.</p>
        <p>The catalog view <codeph>gp_stat_replication</codeph> contains metadata of the
                <systemoutput>walsender</systemoutput> process that is used for Greenplum Database
            master and segment mirroring.</p>
        <p>Mirror segments can be placed on hosts in the cluster in different configurations, as
            long as the primary and mirror instance for a segment are on different hosts. Each host
            must have the same number of primary and mirror segments. The default mirroring
            configuration is <i>group mirroring</i>, where the mirror segments for each host's
            primary segments are placed on one other host. If a single host fails, the number of
            active primary segments doubles on the host that backs the failed host. <xref
                href="#topic3/fig_rrr_nt2_xt" format="dita"/> illustrates a group mirroring
            configuration. </p>
        <!--<fig id="ki169754"><image href="../../graphics/mirrorsegs.png" placement="break" width="485px" height="135px"/></fig>-->
        <fig id="fig_rrr_nt2_xt">
            <title>Group Segment Mirroring in Greenplum Database</title>
            <image href="../../graphics/group-mirroring.png" id="image_crm_pt2_xt"/>
        </fig>
        <p><i>Spread mirroring</i> spreads each host's mirrors over multiple hosts so that if any
            single host fails, no other host will have more than one mirror promoted to the active
            primary segment. Spread mirroring is possible only if there are more hosts than segments
            per host. <xref href="#topic3/fig_ew1_qgg_xt" format="dita"/> illustrates the placement
            of mirrors in a spread segment mirroring configuration.</p>
        <fig id="fig_ew1_qgg_xt">
            <title>Spread Segment Mirroring in Greenplum Database</title>
            <image href="../../graphics/spread-mirroring.png" id="image_zjm_wgg_xt"/>
        </fig>
        <p>The Greenplum Database utilities that create mirror segments support group and spread
            segment configurations. Custom mirroring configurations can be described in a
            configuration file and passed on the command line. </p>
    </body>
</topic>
